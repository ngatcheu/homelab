---
- name: Update VMs with zero-downtime maintenance
  hosts: all
  gather_facts: true
  serial: 1
  become: true
  vars:
    # Configuration pour la maintenance Kubernetes
    drain_timeout: 600  # 10 minutes timeout pour le drain
    grace_period: 300   # 5 minutes pour l'arrêt gracieux des pods
    node_ready_timeout: 180  # 3 minutes pour que le noeud soit ready
    pod_ready_timeout: 300  # 5 minutes pour que les pods soient ready
    kubeconfig_path: "/etc/rancher/rke2/rke2.yaml"  # Chemin vers kubeconfig RKE2
    kubectl_path: "/var/lib/rancher/rke2/bin"  # Chemin vers kubectl binaire

  tasks:
    - name: "Pre-check - Display selected master"
      ansible.builtin.debug:
        msg: "✅ Using master {{ groups['masters'][0] }} for kubectl operations (current node: {{ inventory_hostname }})"

    # Message d'information selon le type de noeud
    - name: "Info - Node type identification"
      ansible.builtin.debug:
        msg: >-
          {{ inventory_hostname }} is a
          {{ 'MASTER node - will skip cordon/drain operations if reboot needed' if inventory_hostname in groups['masters']
             else 'WORKER node - will perform full cordon/drain sequence if reboot needed' }}

    # Etape 1: Update du système d'abord
    - name: "Step 1 - Upgrade all packages"
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true
        update_only: true

    - name: "Step 1 - Autoremove unneeded packages"
      ansible.builtin.dnf:
        autoremove: true

    # Etape 2: Vérifier si reboot nécessaire et déclencher la maintenance si besoin
    - name: "Step 2 - Check if reboot is required"
      ansible.builtin.command:
        cmd: "needs-restarting -r"
      register: needs_restarting
      failed_when: needs_restarting.rc > 1
      changed_when: needs_restarting.rc == 1
      notify:
        - Perform maintenance sequence

  handlers:
    # Handler qui inclut le playbook de maintenance
    - name: Perform maintenance sequence
      ansible.builtin.include_tasks: node-maintenance-tasks.yml
